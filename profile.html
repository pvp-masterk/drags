<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="drags.png" type="image/png">
  <title>Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #5865F2;
      --primary-dark: #4752C4;
      --primary-light: rgba(88, 101, 242, 0.1);
      --secondary: #57F287;
      --secondary-dark: #45d67d;
      --text: #f5f5f5;
      --text-light: rgba(245, 245, 245, 0.7);
      --bg: #1e1e2e;
      --bg-dark: #171722;
      --card-bg: #2a2a3a;
      --card-hover: #313145;
      --accent: #ED4245;
      --accent-hover: #ff5356;
      --header-height: 80px;
      --transition-fast: 0.2s ease;
      --transition-medium: 0.3s ease;
      --transition-slow: 0.5s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      min-height: 100vh;
      padding-top: var(--header-height);
    }


    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: var(--header-height);
      padding: 0 5%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      background: rgba(30, 30, 46, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: all var(--transition-medium);
      box-shadow: 0 2px 30px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    header.scrolled {
      height: 70px;
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: transform var(--transition-fast);
    }
    
    .logo:hover {
      transform: translateX(3px);
    }
    
    .logo i {
      color: var(--primary);
      font-size: 28px;
      transition: transform var(--transition-medium);
    }
    
    .logo:hover i {
      transform: rotate(15deg);
    }
    
    .nav-links {
      display: flex;
      gap: 25px;
      height: 100%;
    }
    
    .nav-links a {
      color: var(--text-light);
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      position: relative;
      transition: all var(--transition-fast);
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 5px;
    }
    
    .nav-links a:hover {
      color: var(--text);
    }
    
    .nav-links a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 3px;
      background: var(--primary);
      transition: width var(--transition-medium);
      border-radius: 3px 3px 0 0;
    }
    
    .nav-links a:hover::after {
      width: 100%;
    }

    .nav-links a.active {
      color: var(--text);
    }

    .nav-links a.active::after {
      width: 100%;
    }


    .profile-container {
      max-width: 500px;
      margin: 30px auto;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      animation: fadeInUp 0.6s ease both;
      transition: all var(--transition-medium);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.05);
      will-change: transform;
    }

    .profile-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%);
      opacity: 0;
      transition: opacity var(--transition-medium);
      z-index: 0;
    }

    .profile-container:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    .profile-container:hover::before {
      opacity: 0.6;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid var(--primary);
      object-fit: cover;
      margin-bottom: 20px;
      transition: all var(--transition-medium);
      position: relative;
      z-index: 2;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .profile-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
    }

    .profile-username {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
      position: relative;
      z-index: 2;
    }

    .profile-displayname {
      font-size: 18px;
      color: var(--text-light);
      margin-bottom: 10px;
      position: relative;
      z-index: 2;
    }

    .profile-userid {
      margin-top: 10px;
      font-size: 14px;
      color: var(--text-light);
      position: relative;
      z-index: 2;
    }

    .profile-bio {
      margin: 20px 0;
      font-size: 15px;
      color: var(--text-light);
      line-height: 1.5;
      position: relative;
      z-index: 2;
    }


    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(30px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }


    .loading-buffer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text);
      z-index: 9999;
      background: rgba(30, 30, 46, 0.9);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--primary);
      border-top: 4px solid transparent;
      border-radius: 50%;
      margin: 0 auto 20px auto;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }


    .badge-box {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 16px;
      margin-top: 25px;
      max-width: 100%;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      transition: all var(--transition-medium);
    }

    .badge-box:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-3px);
    }

    .badge-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      transition: all var(--transition-medium);
    }

    .badge-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      position: relative;
      transition: all var(--transition-fast);
      object-fit: contain;
      background: rgba(0, 0, 0, 0.2);
    }

    .badge-icon:hover {
      transform: scale(1.15) rotate(5deg);
    }

    .badge-icon.glow {
      box-shadow: 0 0 10px #ffffffaa, 0 0 20px #ffffff66;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .badge-box h4 {
      margin: 0 0 20px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    @keyframes rainbowGlow {
      0% {
        box-shadow: 0 0 8px #ff0000, 0 0 16px #ff9900;
        border-color: #ff0000;
      }
      25% {
        box-shadow: 0 0 8px #ff9900, 0 0 16px #ffff00;
        border-color: #ff9900;
      }
      50% {
        box-shadow: 0 0 8px #33ff00, 0 0 16px #00ffff;
        border-color: #33ff00;
      }
      75% {
        box-shadow: 0 0 8px #0066ff, 0 0 16px #9900ff;
        border-color: #0066ff;
      }
      100% {
        box-shadow: 0 0 8px #ff00aa, 0 0 16px #ff0000;
        border-color: #ff00aa;
      }
    }

    .badge-icon.rainbow {
      animation: rainbowGlow 3s infinite ease-in-out;
    }

    .badge-wrapper {
      position: relative;
      display: inline-block;
    }

    .badge-tooltip {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 30, 46, 0.95);
      color: var(--text);
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 400;
      white-space: nowrap;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: all var(--transition-fast);
      width: max-content;
      max-width: 250px;
      z-index: 10;
      text-align: center;
      line-height: 1.4;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .badge-wrapper:hover .badge-tooltip {
      opacity: 1;
      bottom: calc(100% + 15px);
    }

    .badge-tooltip strong {
      font-weight: 700;
      color: var(--secondary);
      display: block;
      margin-bottom: 5px;
    }

    .badge-tooltip span {
      display: block;
      font-weight: 400;
      color: #aaa;
    }

    .dragcoins {
      font-size: 16px;
      color: var(--secondary);
      margin-top: 15px;
      font-weight: 600;
      position: relative;
      z-index: 2;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .dragcoins::before {
      content: '🪙';
      font-size: 18px;
    }


    .follow-section {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      position: relative;
      z-index: 2;
    }

    .follow-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 25px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-medium);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(88, 101, 242, 0.3);
    }

    .follow-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
    }

    .follow-btn.following {
      background: var(--secondary);
      color: #1e1e2e;
      box-shadow: 0 4px 15px rgba(87, 242, 135, 0.3);
    }

    .follow-btn.following:hover {
      background: var(--secondary-dark);
      box-shadow: 0 6px 20px rgba(87, 242, 135, 0.4);
    }

    .follow-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
      position: relative;
      z-index: 2;
    }

    .follow-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      padding: 10px 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
    }

    .follow-stat:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-3px);
    }

    .follow-stat-count {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary);
    }

    .follow-stat-label {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 3px;
    }


    .task-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 350px;
      height: 100%;
      background: rgba(30, 30, 46, 0.98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-left: 1px solid var(--primary);
      color: var(--text);
      padding: 25px;
      transition: right var(--transition-medium);
      z-index: 1000;
      box-shadow: -5px 0 30px rgba(0, 0, 0, 0.4);
      overflow-y: auto;
    }

    .task-panel.active {
      right: 0;
    }

    .task-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .task-panel-header h3 {
      margin: 0;
      font-size: 20px;
      color: var(--secondary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .task-panel button {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 20px;
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .task-panel button:hover {
      color: var(--text);
    }


    #taskToggleBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--primary);
      color: white;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      z-index: 1001;
      cursor: pointer;
      box-shadow: 0 5px 25px rgba(0,0,0,0.4);
      transition: all var(--transition-medium);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #taskToggleBtn:hover {
      background: var(--primary-dark);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }


    .follow-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-medium);
    }

    .follow-modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .follow-modal-content {
      background: var(--card-bg);
      border-radius: 20px;
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      animation: fadeInUp var(--transition-medium) both;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .follow-modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
    }

    .follow-modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .follow-modal-close {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .follow-modal-close:hover {
      color: var(--text);
    }

    .follow-modal-list {
      padding: 0;
      margin: 0;
      list-style: none;
      overflow-y: auto;
      max-height: calc(80vh - 70px);
    }

    .follow-modal-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: background var(--transition-fast);
      cursor: pointer;
    }

    .follow-modal-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .follow-modal-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: transform var(--transition-fast);
    }

    .follow-modal-item:hover .follow-modal-avatar {
      transform: scale(1.1);
    }

    .follow-modal-username {
      font-weight: 600;
      font-size: 15px;
    }

    .follow-modal-displayname {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 3px;
    }


    .theme-bg {
      background: linear-gradient(135deg, #1e1e2e, #2a2a3a);
      transition: background var(--transition-slow);
    }

    .theme-majestic {
      background: linear-gradient(135deg, #1c2e6c, #3e64ff);
    }

    .theme-fractal {
      background: linear-gradient(135deg, #eeeeee, #c0c0c0);
      color: #000;
    }

    .theme-drags_featured {
      background: linear-gradient(135deg, #1c2e6c, #000000);
    }

    .theme-black_white {
      background: linear-gradient(135deg, black, white);
    }


    .username-rainbow {
      background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
      background-size: 200% auto;
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
      animation: rainbowMove 3s linear infinite;
    }

    @keyframes rainbowMove {
      0% { background-position: 0% }
      100% { background-position: 200% }
    }

    .username-glow {
      color: white;
      text-shadow: 0 0 10px currentColor;
      animation: pulseGlow 2s infinite alternate;
    }

    @keyframes pulseGlow {
      from { text-shadow: 0 0 8px currentColor; }
      to { text-shadow: 0 0 15px currentColor; }
    }

    .username-fractal {
      color: black !important;
    }


    @media (max-width: 768px) {
      .profile-container {
        margin: 20px 15px;
        padding: 25px;
      }
      
      .nav-links {
        gap: 15px;
      }
      
      .task-panel {
        width: 300px;
      }
      
      #taskToggleBtn {
        width: 50px;
        height: 50px;
        font-size: 20px;
        bottom: 20px;
        right: 20px;
      }
    }

    @media (max-width: 480px) {
      header {
        padding: 0 20px;
      }
      
      .logo {
        font-size: 20px;
      }
      
      .nav-links {
        gap: 12px;
      }
      
      .nav-links a {
        font-size: 14px;
      }
      
      .profile-avatar {
        width: 100px;
        height: 100px;
      }
      
      .follow-stats {
        gap: 20px;
      }
    }
  </style>
</head>
<body class="theme-bg">
  <header id="header">
    <a href="#" class="logo"><i class="fab fa-discord"></i> Drags</a>
    <nav class="nav-links">
      <a href="index" class="active">Home</a>
      <a href="users">User List</a>
      <a href="settings">Settings</a>
      <a href="terms">Terms of Usage</a>
      <a href="apply">Apply for Staff</a>
    </nav>
    <div id="user-box"></div>
  </header>

  <div id="loading-buffer" class="loading-buffer">
    <div class="spinner"></div>
    <p>Loading Profile Data...</p>
  </div>

  <div id="profileCard" class="profile-container">
    <img id="profileAvatar" class="profile-avatar" src="" alt="Avatar" />
    <div class="username-wrapper">
      <span id="username" class="profile-username">Loading...</span>
    </div>
    <div id="displayName" class="profile-displayname">Loading...</div>
    <div id="userId" class="profile-userid">ID: Loading...</div>
    <p id="userBio" class="profile-bio"></p>
    
    <div class="follow-section">
      <button id="followBtn" class="follow-btn" style="display: none;">
        <i class="fas fa-user-plus"></i> Follow
      </button>
    </div>

    <div class="follow-stats">
      <div class="follow-stat" id="followersStat">
        <span class="follow-stat-count" id="followersCount">0</span>
        <span class="follow-stat-label">Followers</span>
      </div>
      <div class="follow-stat" id="followingStat">
        <span class="follow-stat-count" id="followingCount">0</span>
        <span class="follow-stat-label">Following</span>
      </div>
    </div>

    <div class="dragcoins" id="dragcoins">Loading balance...</div>
    
    <div id="badgeBox" class="badge-box">
      <h4>Badges</h4>
      <div id="badgeContainer" class="badge-container"></div>
    </div>
  </div>


  <div id="taskPanel" class="task-panel">
    <div class="task-panel-header">
      <h3><i class="fas fa-tasks"></i> Daily Tasks</h3>
      <button onclick="toggleTaskPanel()"><i class="fas fa-times"></i></button>
    </div>
    <div id="taskPanelContent">Loading...</div>
  </div>

  <button id="taskToggleBtn" onclick="toggleTaskPanel()"><i class="fas fa-tasks"></i></button>
  

  <div class="follow-modal" id="followersModal">
    <div class="follow-modal-content">
      <div class="follow-modal-header">
        <h3><i class="fas fa-users"></i> Followers</h3>
        <button class="follow-modal-close"><i class="fas fa-times"></i></button>
      </div>
       <div class="spinner follow-loading-spinner" style="margin: 20px auto; display: none;"></div>
      <ul class="follow-modal-list" id="followersList"></ul>
    </div>
  </div>

  <div class="follow-modal" id="followingModal">
    <div class="follow-modal-content">
      <div class="follow-modal-header">
        <h3><i class="fas fa-user-friends"></i> Following</h3>
        <button class="follow-modal-close"><i class="fas fa-times"></i></button>
      </div>
      <ul class="follow-modal-list" id="followingList"></ul>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://akektlyhqzbatuedgnuq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrZWt0bHlocXpiYXR1ZWRnbnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjUwNzUsImV4cCI6MjA2NzgwMTA3NX0.NqsB9Gj4_ZbZw9DgLiLxz2hwEyQvd7tCYy-drMbLGCg"
    );

    const discordId = new URLSearchParams(window.location.search).get("discord_id");
    const currentUserId = localStorage.getItem("loggedInDiscordId");


    window.addEventListener('scroll', () => {
      const header = document.getElementById('header');
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    async function loadProfile(discordId) {
      const loadingBuffer = document.getElementById("loading-buffer");
      if (loadingBuffer) loadingBuffer.style.display = "block";
      
      const { data: user, error } = await supabase
        .from("users")
        .select("*")
        .eq("discord_id", discordId)
        .single();

      if (error || !user) {
        console.error("Failed to load profile:", error);
        if (loadingBuffer) loadingBuffer.innerHTML = "<p>❌ Failed to load profile.</p>";
        return;
      }

      const avatarUrl = user.avatar_url || `https://cdn.discordapp.com/embed/avatars/${parseInt(discordId >> 22) % 5}.png`;

      const { data: authData } = await supabase.auth.getUser();
      const myDiscordId = authData?.user?.user_metadata?.discord_id;
      const profileContainer = document.querySelector(".profile-container") || document.body;


      profileContainer.classList.remove("theme-majestic", "theme-fractal", "theme-drags_featured", "theme-black_white");


      if (user.profile_theme) {
        profileContainer.classList.add(`theme-${user.profile_theme}`);
      }

      const badgeBox = document.getElementById("badgeBox");
      const badgeContainer = document.getElementById("badgeContainer");

      if (badgeContainer) {
        badgeContainer.innerHTML = "";
      }

      const assigned = manualBadges[user.discord_id] || [];

if (assigned.length > 0 && badgeBox && badgeContainer) {
  badgeBox.style.display = "flex";

  // Sort badges by the `order` value
  assigned.sort((a, b) => a.order - b.order).forEach(badgeData => {
    const badge = badgeMap[badgeData.key];
    if (badge) {
      const wrapper = document.createElement("div");
      wrapper.className = "badge-wrapper";

      const img = document.createElement("img");
      img.src = badge.icon;
      img.alt = badge.name;
      img.className = "badge-icon";

      if (["owner", "dev"].includes(badgeData.key)) {
        img.classList.add("rainbow");
      }

      const tooltip = document.createElement("div");
      tooltip.className = "badge-tooltip";
      tooltip.innerHTML = `
        <strong>${badge.name}</strong>
        <span>${badge.description}</span>
      `;

      wrapper.appendChild(img);
      wrapper.appendChild(tooltip);
      badgeContainer.appendChild(wrapper);
    }
  });
}


      const isOwner = currentUserId === discordId;

      async function checkFollowStatus(targetId) {
        const currentUserId = localStorage.getItem("loggedInDiscordId");
        
        if (!currentUserId) return { isFollowing: false, followers: 0, following: 0 };
        

        const { data: isFollowing } = await supabase
          .from("follows")
          .select()
          .eq("follower_id", currentUserId)
          .eq("followed_id", targetId)
          .single();


        const { count: followers } = await supabase
          .from("follows")
          .select("*", { count: "exact", head: true })
          .eq("followed_id", targetId);


        const { count: following } = await supabase
          .from("follows")
          .select("*", { count: "exact", head: true })
          .eq("follower_id", currentUserId);

        return {
          isFollowing: !!isFollowing,
          followers: followers || 0,
          following: following || 0
        };
      }

      async function toggleFollow(targetId) {
  const currentUserId = localStorage.getItem("loggedInDiscordId");
  if (!currentUserId) {
    alert("Please log in to follow users");
    return;
  }

  const followBtn = document.getElementById("followBtn");
  if (!followBtn) return;
  
  followBtn.disabled = true;
  
  try {
    const { data: existingFollow } = await supabase
      .from("follows")
      .select()
      .eq("follower_id", currentUserId)
      .eq("followed_id", targetId)
      .single();

    if (existingFollow) {
      const { error } = await supabase
        .from("follows")
        .delete()
        .eq("id", existingFollow.id);
      
      if (!error) {
        followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
        followBtn.classList.remove("following");

        const countElement = document.getElementById("followersCount");
        if (countElement) {
          countElement.textContent = parseInt(countElement.textContent) - 1;
        }
      }
    } else {
      const { error } = await supabase
        .from("follows")
        .insert([{
          follower_id: currentUserId,
          followed_id: targetId,
          created_at: new Date().toISOString()
        }]);
      
      if (!error) {
        followBtn.innerHTML = '<i class="fas fa-user-check"></i> Following';
        followBtn.classList.add("following");

       const countElement = document.getElementById("followersCount");
if (countElement) {
  const currentCount = parseInt(countElement.textContent);
  countElement.textContent = Math.max(0, currentCount - 1);
}

      }
    }
  } catch (error) {
    console.error("Follow error:", error);
    alert("An error occurred. Please try again.");
  } finally {
    followBtn.disabled = false;
  }
}


const followBtn = document.getElementById("followBtn");
if (followBtn) {
  followBtn.addEventListener('click', () => {
    const targetId = new URLSearchParams(window.location.search).get('discord_id');
    if (targetId) toggleFollow(targetId);
  });
}

     async function loadFollowers(targetId) {
  const { data: followers, error } = await supabase
    .from("follows")
    .select(`
      follower_id,
    users:users!follower_id(username, display_name, avatar_url)
    `)
    .eq("followed_id", targetId)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error loading followers:", error);
    return [];
  }
  return followers || [];
}

async function loadFollowing(targetId) {
  const { data: following, error } = await supabase
    .from("follows")
    .select(`
      followed_id,
      users:users!followed_id(username, display_name, avatar_url)
    `)
    .eq("follower_id", targetId)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error loading following:", error);
    return [];
  }
  return following || [];
}
      

      const followersStat = document.getElementById('followersStat');
      const followingStat = document.getElementById('followingStat');
      
      if (followersStat) {
        followersStat.addEventListener('click', async () => {
          const discordId = new URLSearchParams(window.location.search).get("discord_id") || 
                          localStorage.getItem("loggedInDiscordId");
          if (!discordId) return;
          
          const followers = await loadFollowers(discordId);
          showFollowModal('followersModal', 'followersList', followers, 'Followers');
        });
      }

      if (followingStat) {
        followingStat.addEventListener('click', async () => {
          const discordId = new URLSearchParams(window.location.search).get("discord_id") || 
                          localStorage.getItem("loggedInDiscordId");
          if (!discordId) return;
          
          const following = await loadFollowing(discordId);
          showFollowModal('followingModal', 'followingList', following, 'Following');
        });
      }

     
      if (followBtn) {
        followBtn.style.display = isOwner ? "none" : "flex";
        

        const { isFollowing, followers, following } = await checkFollowStatus(discordId);
        
        const followersCount = document.getElementById("followersCount");
        const followingCount = document.getElementById("followingCount");
        
        if (followersCount) followersCount.textContent = followers;
        if (followingCount) followingCount.textContent = following;
        
        if (isFollowing) {
          followBtn.innerHTML = '<i class="fas fa-user-check"></i> Following';
          followBtn.classList.add("following");
        } else {
          followBtn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
          followBtn.classList.remove("following");
        }
      }

      const usernameEl = document.getElementById("username");
      if (usernameEl) {
        usernameEl.classList.remove("username-rainbow", "username-glow", "username-fractal");

        if (user.username_effect === "rainbow") {
          usernameEl.classList.add("username-rainbow");
        } if (user.username_effect === "glow") {
  usernameEl.classList.add("username-glow");
  const glowColor = user.username_glow_color || "#ffffff";
  usernameEl.style.textShadow = `0 0 8px ${glowColor}, 0 0 14px ${glowColor}, 0 0 20px ${glowColor}`;
  usernameEl.style.color = glowColor;
}

          }
        
      


      const profileAvatar = document.getElementById("profileAvatar");
      const username = document.getElementById("username");
      const displayName = document.getElementById("displayName");
      const userId = document.getElementById("userId");
      const userBio = document.getElementById("userBio");
      const dragcoins = document.getElementById("dragcoins");

      if (profileAvatar) profileAvatar.src = avatarUrl;
      if (username) username.textContent = `@${user.username}`;
      if (displayName) displayName.innerHTML = `${user.display_name || user.username}`;
      if (userId) userId.textContent = `ID: ${user.discord_id}`;
      if (userBio) {
  const rawBio = user.bio || "";
  const formattedBio = rawBio.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
  userBio.innerHTML = formattedBio;
}

      if (dragcoins) dragcoins.textContent = `💰 ${user.dragcoins}`;

      if (loadingBuffer) loadingBuffer.style.display = "none";
      if (profileCard) profileCard.style.display = "block";

      if (specialGradientUsers.includes(user.discord_id)) {
        const profileCard = document.getElementById("profileCard");
        if (profileCard) profileCard.classList.add("featured");
      }

    
      if (user.profile_theme === "fractal") {
        usernameEl.classList.add("username-fractal");
      }
    }

    if (discordId) {
      loadProfile(discordId);
    }

    const specialGradientUsers = [
      "1303491410472865793", 
      "1392907277463457792",
      "123456789012345678"   
    ];

    const badgeMap = {
  prime: {
    name: "Prime",
    icon: "https://cdn3.emoji.gg/emojis/1445-level.png",
    description: "Elite members with Prime status",
    rarity: "Epic"
  },
  master: {
    name: "Master",
    icon: "https://cdn3.emoji.gg/emojis/1775-master.png",
    description: "Top-tier members with Master rank",
    rarity: "Legendary"
  },
  early: {
    name: "Early User",
    icon: "https://cdn3.emoji.gg/emojis/7549-member.png",
    description: "Joined in the first week",
    rarity: "Rare"
  },
  staff: {
    name: "Staff",
    icon: "https://cdn3.emoji.gg/emojis/1415-moderator.png",
    description: "Official Drags Staff",
    rarity: "Epic"
  },
  verified: {
    name: "Verified",
    icon: "https://cdn3.emoji.gg/emojis/74424-partner.png",
    description: "Verified identity",
    rarity: "Uncommon"
  },
  dev: {
    name: "Developer",
    icon: "https://cdn3.emoji.gg/emojis/1166-partner.png",
    description: "Platform Developer",
    rarity: "Epic"
  },
  owner: {
    name: "Founder & Owner",
    icon: "https://cdn3.emoji.gg/emojis/8259-owner.png",
    description: "The original founder of Drags",
    rarity: "Legendary"
  }
};


    const manualBadges = {
  "1303491410472865793": [
    { key: "owner", order: 1 },
    { key: "dev", order: 2 },
    { key: "verified", order: 3 },
    { key: "staff", order: 4 },
    { key: "early", order: 5 },
    { key: "prime", order: 6 }
  ],
  "1359405784915509292": [
    { key: "owner", order: 1 },
    { key: "early", order: 2 },
    { key: "staff", order: 3 }
  ],
  "1359405784915509232": [
    { key: "staff", order: 1 }
  ]
};



    function showFollowModal(modalId, listId, items, title) {
      const modal = document.getElementById(modalId);
      const list = document.getElementById(listId);
      
      if (!modal || !list) return;
      

      const titleElement = modal.querySelector('h3');
      if (titleElement) titleElement.textContent = title;
      

    list.innerHTML = '';
const spinner = modal.querySelector('.follow-loading-spinner');
if (spinner) spinner.style.display = 'block';

      

      if (items.length === 0) {
        list.innerHTML = '<li style="padding: 20px; text-align: center; color: #aaa;">No items to display</li>';
      } else {
        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'follow-modal-item';
          

          const profile = item.users || {};

          li.innerHTML = `
  <a href="profile.html?discord_id=${item.follower_id || item.followed_id}" style="display: flex; align-items: center; text-decoration: none; color: inherit; width: 100%;">
    <img src="${profile.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}" 
         class="follow-modal-avatar" 
         alt="${profile.username || 'Unknown'}">
    <div>
      <div class="follow-modal-username">${profile.display_name || profile.username || 'Unknown'}</div>
      <div class="follow-modal-displayname">@${profile.username || 'unknown'}</div>
    </div>
  </a>
`;

          list.appendChild(li);
        });
if (spinner) spinner.style.display = 'none';
      }
      

      modal.classList.add('active');
      

      const closeBtn = modal.querySelector('.follow-modal-close');
      if (closeBtn) {
        closeBtn.onclick = () => modal.classList.remove('active');
      }
      

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
       
    }


   
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://akektlyhqzbatuedgnuq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrZWt0bHlocXpiYXR1ZWRnbnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjUwNzUsImV4cCI6MjA2NzgwMTA3NX0.NqsB9Gj4_ZbZw9DgLiLxz2hwEyQvd7tCYy-drMbLGCg"
    );

    function toggleTaskPanel() {
      const panel = document.getElementById("taskPanel");
      panel.classList.toggle("active");
    }

    async function loadTaskPanel() {
      const discordId = localStorage.getItem("loggedInDiscordId");
      const today = new Date().toISOString().split("T")[0];
      const { data: assignedTasks, error } = await supabase
        .from("user_tasks")
        .select("id, completed, task_pool(title, reward)")
        .eq("discord_id", discordId)
        .eq("assigned_date", today);

      const container = document.getElementById("taskPanelContent");

      if (!assignedTasks || assignedTasks.length === 0) {
        container.innerHTML = "<p style='text-align: center; padding: 20px; color: var(--text-light);'>No tasks assigned today.</p>";
        return;
      }

      container.innerHTML = assignedTasks.map(t => `
        <div class="task" style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${t.task_pool.title}</strong>
              <div style="font-size: 13px; color: ${t.completed ? 'var(--secondary)' : 'var(--text-light)'}; margin-top: 5px;">
                ${t.completed ? '<i class="fas fa-check-circle"></i> Completed' : '<i class="fas fa-clock"></i> In Progress'}
              </div>
            </div>
            <div class="reward" style="background: rgba(87, 242, 135, 0.1); color: var(--secondary); padding: 5px 10px; border-radius: 20px; font-size: 14px;">
              ${t.task_pool.reward} <i class="fas fa-coins"></i>
            </div>
          </div>
        </div>
      `).join("");
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadTaskPanel();
      

      const profileCard = document.getElementById('profileCard');
      if (profileCard) {
        setTimeout(() => {
          profileCard.style.opacity = '1';
          profileCard.style.transform = 'translateY(0)';
        }, 100);
      }
    });
  </script>
</body>
</html>
