<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings</title>
  <link rel="icon" href="drags.png" type="image/png">
  <link rel="stylesheet" href="style.css" />
  <style>
     :root {
            --primary: #5865F2;
            --primary-dark: #4752C4;
            --secondary: #57F287;
            --text: #f5f5f5;
            --bg: #1e1e2e;
            --card-bg: #2a2a3a;
            --accent: #ED4245;
        }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 40px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .settings-container {
      max-width: 600px;
      margin: auto;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      transform: translateY(20px);
      opacity: 0;
      animation: slideUp 0.4s ease forwards 0.2s;
    }

    @keyframes slideUp {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .settings-container h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: 500;
      animation: fadeIn 0.5s ease forwards;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: none;
      background: #2f2f45;
      color: white;
      transition: all 0.3s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--primary);
      transform: scale(1.01);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .save-btn {
      margin-top: 30px;
      width: 100%;
      background: var(--primary);
      border: none;
      color: white;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .save-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(88, 101, 242, 0.3);
    }

    .save-btn:active {
      transform: translateY(0);
    }

    .save-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }

    .save-btn:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }

    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }

    .badge-section {
      background: #2b2b3e;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      animation: fadeIn 0.5s ease forwards;
    }

    .badge-item {
      background: #3a3a55;
      color: white;
      padding: 6px 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .badge-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .badge-item button {
      background: transparent;
      border: none;
      color: var(--secondary);
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .badge-item button:hover {
      transform: scale(1.2);
    }

    .select-theme-btn {
      margin-top: 10px;
      padding: 10px 20px;
      background: var(--primary);
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .select-theme-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(88, 101, 242, 0.3);
    }

    .theme-modal {
      position: fixed;
      top: 0;
      left: 0;
      display: none;
      width: 100%;
      height: 100%;
      background: rgba(20, 20, 30, 0.8);
      backdrop-filter: blur(6px);
      z-index: 999;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .theme-modal.show {
      display: flex;
      opacity: 1;
    }

    .theme-modal-content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      text-align: center;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .theme-modal.show .theme-modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .theme-options {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 20px 0;
    }

    .theme-card {
      background: #25253b;
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .theme-card:hover {
      background: #2f2f4f;
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .gradient {
      height: 60px;
      border-radius: 10px;
      margin-bottom: 6px;
      transition: all 0.3s ease;
    }

    .gradient.majestic {
      background: linear-gradient(135deg, #1c2e6c, #3e64ff);
    }

    .gradient.fractal {
      background: linear-gradient(135deg, #eeeeee, #c0c0c0);
    }

    .gradient.drags-featured {
      background: linear-gradient(135deg, #1c2e6c, #000000);
      position: relative;
    }

    .featured-label {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 11px;
      background: var(--primary);
      color: white;
      padding: 2px 6px;
      border-radius: 6px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .gradient.black-white {
      background: linear-gradient(135deg, black, white);
    }

    .effect-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 10px;
      background: #2f2f45;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .effect-option:hover {
      background: #3a3a55;
    }

    .effect-option input[type="checkbox"] {
      width: auto;
      appearance: none;
      -webkit-appearance: none;
      height: 18px;
      width: 18px;
      border: 2px solid var(--primary);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .effect-option input[type="checkbox"]:checked {
      background: var(--primary);
    }

    .effect-option input[type="checkbox"]:checked::after {
      content: "✓";
      color: white;
      font-size: 12px;
    }

    .effect-options-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: -400px;
      background: #2e2e3e;
      color: white;
      padding: 16px 24px;
      border-left: 6px solid var(--primary);
      border-radius: 10px;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .toest.show {
      right: 20px;
    }

    .toast.error {
      border-left-color: var(--accent);
    }

    .toast.success {
      border-left-color: var(--secondary);
    }

    .toast-icon {
      font-size: 20px;
    }

    .toast.show {
      right: 20px;
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .close-modal {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-modal:hover {
      background: #c03939;
      transform: translateY(-2px);
    }

    .glow-color-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      opacity: 0;
      height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .glow-color-container.show {
      opacity: 1;
      height: auto;
      padding: 10px;
      background: #2f2f45;
      border-radius: 8px;
    }

    .glow-color-container label {
      margin-top: 0;
    }

    input[type="color"] {
      width: 50px;
      height: 30px;
      padding: 2px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <h2>⚙️ Profile Settings</h2>

    <label for="displayName">Display Name</label>
    <input type="text" id="displayName" placeholder="Your display name" />

    <label for="bio">Bio</label>
    <textarea id="bio" placeholder="Write something about you..."></textarea>
    
    <label for="badgeSection">Badges to Show</label>
    <div id="badgeSection" class="badge-section"></div>
    
    <label for="themeSelector">Profile Theme</label>
    <button class="select-theme-btn" onclick="openThemeModal()">Select Theme</button>
    <div id="selectedThemeLabel" style="margin-top: 10px; font-size: 14px; color: var(--secondary);"></div>

    <!-- Modal -->
    <div id="themeModal" class="theme-modal">
      <div class="theme-modal-content">
        <h3>Select Your Theme</h3>
        <div class="theme-options">
          <div class="theme-card" data-theme="majestic">
            <div class="gradient majestic"></div>
            <span>Majestic</span>
          </div>
          <div class="theme-card" data-theme="fractal">
            <div class="gradient fractal"></div>
            <span>Fractal</span>
          </div>
          <div class="theme-card" data-theme="drags_featured">
            <div class="gradient drags-featured">
              <span class="featured-label">Featured</span>
            </div>
            <span>Drags Featured</span>
          </div>
          <div class="theme-card" data-theme="black_white">
            <div class="gradient black-white"></div>
            <span>Black and White</span>
          </div>
        </div>
        <button onclick="closeThemeModal()" class="close-modal">Close</button>
      </div>
    </div>
   
    <label>Username Effects</label>
    <div class="effect-options-container">
      <div class="effect-option">
        <input type="checkbox" id="rainbowEffect" onchange="toggleEffect('rainbow')">
        <label for="rainbowEffect">Rainbow Gradient</label>
      </div>
      <div class="effect-option">
        <input type="checkbox" id="glowEffect" onchange="toggleEffect('glow')">
        <label for="glowEffect">Shiny Glow</label>
      </div>
    </div>

    <div id="glowColorContainer" class="glow-color-container">
      <label for="glowColorPicker">Glow Color</label>
      <input type="color" id="glowColorPicker" value="#ffffff" />
    </div>

    <div id="toast" class="toast">
      <span class="toast-icon">ℹ️</span>
      <span class="toast-message"></span>
    </div>

    <button class="save-btn" onclick="saveSettings()">Save Settings</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const supabase = window.supabase.createClient(
      "https://akektlyhqzbatuedgnuq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrZWt0bHlocXpiYXR1ZWRnbnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjUwNzUsImV4cCI6MjA2NzgwMTA3NX0.NqsB9Gj4_ZbZw9DgLiLxz2hwEyQvd7tCYy-drMbLGCg"
    );

    const discordId = localStorage.getItem("loggedInDiscordId");
    let badgeOrder = [];
    let originalSettings = {};
    let selectedTheme = "";
    let selectedEffects = [];

    async function loadSettings() {
      const { data, error } = await supabase
        .from("users")
        .select("display_name, bio, badges, profile_theme, username_effect, username_glow_color")
        .eq("discord_id", discordId)
        .single();

      if (data) {
        document.getElementById("displayName").value = data.display_name || "";
        document.getElementById("bio").value = data.bio || "";
        
        // Load effects
        if (data.username_effect) {
          selectedEffects = data.username_effect.split(',');
          selectedEffects.forEach(effect => {
            if (effect === 'rainbow') document.getElementById("rainbowEffect").checked = true;
            if (effect === 'glow') document.getElementById("glowEffect").checked = true;
          });
          updateGlowColorVisibility();
        }
        
        // Load theme
        if (data.profile_theme) {
          selectedTheme = data.profile_theme;
          document.getElementById("selectedThemeLabel").textContent = `Selected Theme: ${formatThemeName(selectedTheme)}`;
        }
        
        // Load glow color
        if (data.username_glow_color) {
          document.getElementById("glowColorPicker").value = data.username_glow_color;
        }

        // Load badges
        badgeOrder = data.badges || [];
        renderBadgeSection();
      }

      originalSettings = {
        displayName: data?.display_name || "",
        bio: data?.bio || "",
        effect: data?.username_effect || "",
        theme: data?.profile_theme || "",
        badges: JSON.stringify(data?.badges || []),
        glowColor: data?.username_glow_color || "#ffffff"
      };

      window.onbeforeunload = () => {
        const current = {
          displayName: document.getElementById("displayName").value,
          bio: document.getElementById("bio").value,
          effect: selectedEffects.join(','),
          theme: selectedTheme,
          badges: JSON.stringify(badgeOrder),
          glowColor: document.getElementById("glowColorPicker").value
        };

        for (let key in current) {
          if (current[key] !== originalSettings[key]) {
            return "You have unsaved changes!";
          }
        }
      };
    }

    function toggleEffect(effect) {
      const checkbox = document.getElementById(`${effect}Effect`);
      if (checkbox.checked) {
        if (!selectedEffects.includes(effect)) {
          selectedEffects.push(effect);
        }
      } else {
        selectedEffects = selectedEffects.filter(e => e !== effect);
      }
      updateGlowColorVisibility();
    }

    function updateGlowColorVisibility() {
      const container = document.getElementById("glowColorContainer");
      if (selectedEffects.includes('glow')) {
        container.classList.add("show");
      } else {
        container.classList.remove("show");
      }
    }

    async function saveSettings() {
      const displayName = document.getElementById("displayName").value;
      const bio = document.getElementById("bio").value;
      const glowColor = document.getElementById("glowColorPicker").value;
      const effects = selectedEffects.join(',');

      const saveBtn = document.querySelector('.save-btn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="saving-spinner">Saving...</span>';

      try {
        const { error } = await supabase
          .from("users")
          .update({
            display_name: displayName,
            bio: bio,
            badges: badgeOrder,
            profile_theme: selectedTheme,
            username_effect: effects,
            username_glow_color: glowColor
          })
          .eq("discord_id", discordId);

        if (!error) {
          showToast("Settings saved successfully!", "success");
          originalSettings = {
            displayName,
            bio,
            effect: effects,
            theme: selectedTheme,
            badges: JSON.stringify(badgeOrder),
            glowColor
          };
        } else {
          throw error;
        }
      } catch (error) {
        console.error(error);
        showToast("Failed to save settings", "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Settings';
      }
    }

    async function loadBadges() {
      const { data, error } = await supabase
        .from("users")
        .select("badges")
        .eq("discord_id", discordId)
        .single();

      badgeOrder = data?.badges || [];
      renderBadgeSection();
    }

    function renderBadgeSection() {
      const section = document.getElementById("badgeSection");
      section.innerHTML = "";

      if (!badgeOrder || badgeOrder.length === 0) {
        section.innerHTML = "<p style='color:gray;'>No badges selected.</p>";
        return;
      }

      badgeOrder.forEach((badge, index) => {
        const div = document.createElement("div");
        div.className = "badge-item";
        div.innerHTML = `
          ${badge}
          ${index > 0 ? `<button onclick="moveBadge(${index}, -1)">⬅</button>` : ""}
          ${index < badgeOrder.length - 1 ? `<button onclick="moveBadge(${index}, 1)">➡</button>` : ""}
        `;
        section.appendChild(div);
      });
    }

    function moveBadge(index, direction) {
      const newIndex = index + direction;
      [badgeOrder[index], badgeOrder[newIndex]] = [badgeOrder[newIndex], badgeOrder[index]];
      renderBadgeSection();
    }

    function openThemeModal() {
      const modal = document.getElementById("themeModal");
      modal.classList.add("show");
      setTimeout(() => {
        modal.querySelector('.theme-modal-content').style.transform = "scale(1)";
        modal.querySelector('.theme-modal-content').style.opacity = "1";
      }, 10);
    }

    function closeThemeModal() {
      const modal = document.getElementById("themeModal");
      modal.querySelector('.theme-modal-content').style.transform = "scale(0.9)";
      modal.querySelector('.theme-modal-content').style.opacity = "0";
      setTimeout(() => {
        modal.classList.remove("show");
      }, 300);
    }

    document.querySelectorAll(".theme-card").forEach(card => {
      card.addEventListener("click", () => {
        selectedTheme = card.dataset.theme;
        document.getElementById("selectedThemeLabel").textContent = `Selected Theme: ${formatThemeName(selectedTheme)}`;
        closeThemeModal();
      });
    });

    function formatThemeName(id) {
      const names = {
        majestic: "Majestic",
        fractal: "Fractal",
        drags_featured: "Drags Featured",
        black_white: "Black and White"
      };
      return names[id] || id;
    }

    function showToast(message, type = "info") {
      const toast = document.getElementById("toast");
      const toastMessage = toast.querySelector(".toast-message");
      const toastIcon = toast.querySelector(".toast-icon");
      
      toastMessage.textContent = message;
      toast.className = "toast";
      
      // Set icon and color based on type
      if (type === "success") {
        toastIcon.textContent = "✅";
        toast.classList.add("success");
      } else if (type === "error") {
        toastIcon.textContent = "❌";
        toast.classList.add("error");
      } else {
        toastIcon.textContent = "ℹ️";
      }
      
      // Show toast
      setTimeout(() => {
        toast.classList.add("show");
      }, 10);
      
      // Hide after delay
      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      loadBadges();
    });
  </script>
</body>
</html>
