<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="card slide-up">
      <h2>Settings</h2>
      <form id="settingsForm">
        <label for="displayName">Display Name</label>
        <input type="text" id="displayName" name="displayName" placeholder="Enter display name" />
        <button type="submit">üíæ Save</button>
        <button id="updateAvatarBtn" class="btn-accent">üîÅ Update Avatar</button>

        <p id="status" style="margin-top:10px;"></p>
      </form>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const did = params.get('discord_id');
    const API = 'https://akektlyhqzbatuedgnuq.supabase.co/rest/v1/users';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrZWt0bHlocXpiYXR1ZWRnbnVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjUwNzUsImV4cCI6MjA2NzgwMTA3NX0.NqsB9Gj4_ZbZw9DgLiLxz2hwEyQvd7tCYy-drMbLGCg';

    if (!did) {
      document.body.innerHTML = '<p>‚ùå Missing Discord ID in URL</p>';
      throw new Error('Missing discord_id');
    }

    // Load existing data
    fetch(`${API}?select=*&discord_id=eq.${did}`, {
      headers: {
        apikey: KEY,
        Authorization: `Bearer ${KEY}`
      }
    })
    .then(res => res.json())
    .then(data => {
      const user = data[0];
      if (!user) return document.body.innerHTML = '<p>‚ùå User not found</p>';
      document.getElementById('displayName').value = user.display_name || '';
    });

    // Save settings
    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const displayName = document.getElementById('displayName').value;

      const res = await fetch(`${API}?discord_id=eq.${did}`, {
        method: 'PATCH',
        headers: {
          apikey: KEY,
          Authorization: `Bearer ${KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ display_name: displayName })
      });

      const msg = document.getElementById('status');
      if (res.ok) {
        msg.textContent = '‚úÖ Display name updated!';
        msg.style.color = 'var(--secondary)';
      } else {
        msg.textContent = '‚ùå Update failed.';
        msg.style.color = 'var(--accent)';
      }
    });

document.getElementById("updateAvatarBtn").addEventListener("click", async () => {
  const userId = localStorage.getItem("discord_id");
  if (!userId) return;

  // Re-fetch from Discord API (or wherever your backend logic is)
  try {
    const res = await fetch(`/api/refresh-avatar?discord_id=${userId}`);
    const data = await res.json();

    if (data.success && data.avatar_url) {
      // Update localStorage + UI
      localStorage.setItem("avatar_url", data.avatar_url);
      alert("‚úÖ Avatar updated!");
      window.location.reload(); // Reload to reflect changes
    } else {
      alert("‚ùå Failed to update avatar.");
    }
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Something went wrong.");
  }
});

    
  </script>
</body>
</html>
